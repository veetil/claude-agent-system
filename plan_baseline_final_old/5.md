# Step 5: Integration Testing and Examples

## Objective
Create comprehensive integration tests and user-friendly examples to validate the baseline system functionality.

## Tasks

### 5.1 Integration Test Suite

```typescript
// tests/integration/single-agent.integration.test.ts
import { SimpleAgent } from '../../src/agents/specialized/SimpleAgent';
import { CLIProcessManager } from '../../src/cli/CLIProcessManager';
import { IAgentConfig, ITask } from '../../src/agents/base/types';
import * as fs from 'fs/promises';
import * as path from 'path';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

describe('Single Agent Integration Tests', () => {
  let processManager: CLIProcessManager;
  let testDir: string;

  beforeAll(async () => {
    // Ensure Claude CLI is available
    try {
      await execAsync('claude --version');
    } catch (error) {
      throw new Error('Claude CLI not found. Please install it first.');
    }
  });

  beforeEach(async () => {
    processManager = new CLIProcessManager();
    testDir = `/tmp/claude-integration-test-${Date.now()}`;
    await fs.mkdir(testDir, { recursive: true });
  });

  afterEach(async () => {
    await processManager.shutdown();
    await fs.rm(testDir, { recursive: true, force: true });
  });

  describe('End-to-End Scenarios', () => {
    it('should execute a simple task end-to-end', async () => {
      const config: IAgentConfig = {
        id: 'integration-agent-1',
        name: 'Integration Test Agent',
        type: 'simple',
        workingDirectory: path.join(testDir, 'agent1'),
        systemPrompt: 'You are a helpful assistant. Be concise.',
        model: 'claude-3-opus-20240229'
      };

      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      const task: ITask = {
        id: 'int-task-1',
        type: 'text',
        description: 'What is the sum of 15 and 27?',
        parameters: {}
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result).toContain('42');

      await agent.shutdown();
    });

    it('should handle file operations correctly', async () => {
      // Create test files
      const sourceFile = path.join(testDir, 'source.txt');
      await fs.writeFile(sourceFile, 'This is a test file with important content.');

      const config: IAgentConfig = {
        id: 'integration-agent-2',
        name: 'File Test Agent',
        type: 'simple',
        workingDirectory: path.join(testDir, 'agent2'),
        systemPrompt: 'You are a file analysis expert.',
        model: 'claude-3-opus-20240229'
      };

      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      const task: ITask = {
        id: 'int-task-2',
        type: 'file-analysis',
        description: 'Read data.txt and count the number of words',
        parameters: {
          files: [{
            name: 'data.txt',
            srcPath: sourceFile,
            destPath: './'
          }]
        }
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result.toLowerCase()).toContain('word');
      expect(result.result).toMatch(/\d+/); // Should contain a number

      await agent.shutdown();
    });

    it('should handle multiple files and folders', async () => {
      // Create test structure
      const sourceDir = path.join(testDir, 'source-dir');
      await fs.mkdir(sourceDir, { recursive: true });
      await fs.writeFile(path.join(sourceDir, 'file1.txt'), 'Content 1');
      await fs.writeFile(path.join(sourceDir, 'file2.txt'), 'Content 2');
      
      const config: IAgentConfig = {
        id: 'integration-agent-3',
        name: 'Multi-File Agent',
        type: 'simple',
        workingDirectory: path.join(testDir, 'agent3'),
        systemPrompt: 'You are a file system expert.',
        model: 'claude-3-opus-20240229'
      };

      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      const task: ITask = {
        id: 'int-task-3',
        type: 'file-analysis',
        description: 'List all files in the data folder',
        parameters: {
          folders: [{
            name: 'source-data',
            srcPath: sourceDir,
            destPath: './data'
          }]
        }
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result).toContain('file1');
      expect(result.result).toContain('file2');

      await agent.shutdown();
    });

    it('should handle concurrent tasks', async () => {
      const config: IAgentConfig = {
        id: 'integration-agent-4',
        name: 'Concurrent Test Agent',
        type: 'simple',
        workingDirectory: path.join(testDir, 'agent4'),
        systemPrompt: 'You are a math expert. Answer with just the number.',
        model: 'claude-3-opus-20240229'
      };

      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      const tasks = [
        { id: 'calc-1', type: 'text', description: '10 + 20', parameters: {} },
        { id: 'calc-2', type: 'text', description: '50 - 15', parameters: {} },
        { id: 'calc-3', type: 'text', description: '7 * 8', parameters: {} }
      ];

      const results = await Promise.all(
        tasks.map(task => agent.execute(task))
      );

      expect(results[0].result).toContain('30');
      expect(results[1].result).toContain('35');
      expect(results[2].result).toContain('56');

      await agent.shutdown();
    });
  });

  describe('Error Scenarios', () => {
    it('should recover from agent crashes', async () => {
      const config: IAgentConfig = {
        id: 'integration-agent-5',
        name: 'Crash Test Agent',
        type: 'simple',
        workingDirectory: path.join(testDir, 'agent5'),
        systemPrompt: 'You are a test agent.',
        model: 'claude-3-opus-20240229'
      };

      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      // First task should work
      const task1: ITask = {
        id: 'task-before-crash',
        type: 'text',
        description: 'Say hello',
        parameters: {}
      };

      const result1 = await agent.execute(task1);
      expect(result1.status).toBe('completed');

      // Simulate crash by killing the process
      const activeAgents = processManager.getActiveAgents();
      if (activeAgents.length > 0) {
        await processManager.terminateAgent(activeAgents[0]);
      }

      // Next task should fail gracefully
      const task2: ITask = {
        id: 'task-after-crash',
        type: 'text',
        description: 'Say goodbye',
        parameters: {}
      };

      const result2 = await agent.execute(task2);
      expect(result2.status).toBe('failed');

      await agent.shutdown();
    });
  });
});
```

### 5.2 Example Scripts

```typescript
// examples/01-basic-usage.ts
import { SimpleAgent } from '../src/agents/specialized/SimpleAgent';
import { CLIProcessManager } from '../src/cli/CLIProcessManager';
import { IAgentConfig, ITask } from '../src/agents/base/types';

async function basicUsageExample() {
  console.log('=== Basic Usage Example ===\n');

  const processManager = new CLIProcessManager();

  try {
    // Create agent configuration
    const config: IAgentConfig = {
      id: 'example-agent-1',
      name: 'Example Agent',
      type: 'simple',
      workingDirectory: '/tmp/claude-example-1',
      systemPrompt: 'You are a helpful AI assistant. Be friendly and concise.',
      model: 'claude-3-opus-20240229'
    };

    // Create and initialize agent
    const agent = new SimpleAgent(config, processManager);
    await agent.initialize();
    console.log('✓ Agent initialized\n');

    // Execute a simple task
    const task: ITask = {
      id: 'example-task-1',
      type: 'text',
      description: 'Please introduce yourself and explain what you can do.',
      parameters: {}
    };

    console.log('Sending task to agent...');
    const result = await agent.execute(task);

    if (result.status === 'completed') {
      console.log('\nAgent response:');
      console.log(result.result);
    } else {
      console.error('Task failed:', result.error);
    }

    // Cleanup
    await agent.shutdown();
    await processManager.shutdown();
    console.log('\n✓ Agent shutdown complete');

  } catch (error) {
    console.error('Error:', error);
    await processManager.shutdown();
  }
}

// Run the example
if (require.main === module) {
  basicUsageExample();
}
```

```typescript
// examples/02-file-processing.ts
import { SimpleAgent } from '../src/agents/specialized/SimpleAgent';
import { CLIProcessManager } from '../src/cli/CLIProcessManager';
import { IAgentConfig, ITask } from '../src/agents/base/types';
import * as fs from 'fs/promises';
import * as path from 'path';

async function fileProcessingExample() {
  console.log('=== File Processing Example ===\n');

  const processManager = new CLIProcessManager();

  try {
    // Create sample files
    const tempDir = '/tmp/claude-file-example';
    await fs.mkdir(tempDir, { recursive: true });
    
    await fs.writeFile(
      path.join(tempDir, 'document.txt'),
      `This is a sample document for processing.
      It contains multiple lines of text.
      The agent should be able to read and analyze this content.`
    );

    await fs.writeFile(
      path.join(tempDir, 'data.json'),
      JSON.stringify({ 
        name: 'Example Data',
        values: [1, 2, 3, 4, 5],
        metadata: { created: new Date().toISOString() }
      }, null, 2)
    );

    // Create agent
    const config: IAgentConfig = {
      id: 'file-agent',
      name: 'File Processing Agent',
      type: 'simple',
      workingDirectory: '/tmp/claude-file-agent',
      systemPrompt: 'You are a file analysis expert. Provide detailed analysis of files.',
      model: 'claude-3-opus-20240229'
    };

    const agent = new SimpleAgent(config, processManager);
    await agent.initialize();

    // Task 1: Analyze text file
    console.log('Task 1: Analyzing text file...');
    const textTask: ITask = {
      id: 'analyze-text',
      type: 'file-analysis',
      description: 'Read document.txt and provide a summary',
      parameters: {
        files: [{
          name: 'document.txt',
          srcPath: path.join(tempDir, 'document.txt'),
          destPath: './'
        }]
      }
    };

    const textResult = await agent.execute(textTask);
    console.log('Result:', textResult.result);
    console.log();

    // Task 2: Analyze JSON file
    console.log('Task 2: Analyzing JSON file...');
    const jsonTask: ITask = {
      id: 'analyze-json',
      type: 'file-analysis',
      description: 'Read data.json and calculate the sum of values',
      parameters: {
        files: [{
          name: 'data.json',
          srcPath: path.join(tempDir, 'data.json'),
          destPath: './'
        }]
      }
    };

    const jsonResult = await agent.execute(jsonTask);
    console.log('Result:', jsonResult.result);

    // Cleanup
    await agent.shutdown();
    await processManager.shutdown();
    await fs.rm(tempDir, { recursive: true, force: true });

  } catch (error) {
    console.error('Error:', error);
    await processManager.shutdown();
  }
}

// Run the example
if (require.main === module) {
  fileProcessingExample();
}
```

```typescript
// examples/03-interactive-session.ts
import { SimpleAgent } from '../src/agents/specialized/SimpleAgent';
import { CLIProcessManager } from '../src/cli/CLIProcessManager';
import { IAgentConfig, ITask } from '../src/agents/base/types';
import * as readline from 'readline';

async function interactiveSessionExample() {
  console.log('=== Interactive Session Example ===');
  console.log('Type "help" for commands, "exit" to quit\n');

  const processManager = new CLIProcessManager();
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
    prompt: 'You> '
  });

  try {
    const config: IAgentConfig = {
      id: 'interactive-agent',
      name: 'Interactive Assistant',
      type: 'simple',
      workingDirectory: '/tmp/claude-interactive',
      systemPrompt: `You are an interactive AI assistant. 
        You can help with various tasks including:
        - Answering questions
        - Writing code
        - Analyzing text
        - General conversation
        Be helpful, friendly, and concise.`,
      model: 'claude-3-opus-20240229'
    };

    const agent = new SimpleAgent(config, processManager);
    await agent.initialize();
    console.log('✓ Agent ready for interaction\n');

    const commands = {
      help: () => {
        console.log('\nAvailable commands:');
        console.log('  help     - Show this help message');
        console.log('  clear    - Clear the screen');
        console.log('  status   - Show agent status');
        console.log('  exit     - Exit the session');
        console.log('\nOr just type your message to chat with the agent.\n');
      },
      clear: () => {
        console.clear();
        console.log('=== Interactive Session ===\n');
      },
      status: async () => {
        const stats = await processManager.getAgentStats(config.id);
        console.log('\nAgent Status:');
        console.log(`  Tasks completed: ${stats.tasksCompleted}`);
        console.log(`  Tasks failed: ${stats.tasksFailed}`);
        console.log(`  Uptime: ${Math.round(stats.uptime / 1000)}s`);
        console.log(`  Status: ${stats.busy ? 'Busy' : 'Ready'}\n`);
      }
    };

    rl.prompt();

    rl.on('line', async (input) => {
      const trimmed = input.trim().toLowerCase();

      if (trimmed === 'exit') {
        rl.close();
        return;
      }

      if (trimmed in commands) {
        await commands[trimmed]();
        rl.prompt();
        return;
      }

      // Send to agent
      const task: ITask = {
        id: `msg-${Date.now()}`,
        type: 'text',
        description: input,
        parameters: {}
      };

      try {
        const result = await agent.execute(task);
        if (result.status === 'completed') {
          console.log('\nAgent>', result.result);
        } else {
          console.log('\nError:', result.error);
        }
      } catch (error) {
        console.log('\nError:', error.message);
      }

      console.log(); // Empty line for readability
      rl.prompt();
    });

    rl.on('close', async () => {
      console.log('\nShutting down...');
      await agent.shutdown();
      await processManager.shutdown();
      console.log('Goodbye!');
      process.exit(0);
    });

  } catch (error) {
    console.error('Failed to initialize:', error);
    rl.close();
    await processManager.shutdown();
    process.exit(1);
  }
}

// Run the example
if (require.main === module) {
  interactiveSessionExample();
}
```

### 5.3 User Documentation

```markdown
# Claude Agent System - User Guide

## Quick Start

1. **Installation**
   ```bash
   npm install -g claude-roo
   ```

2. **Basic Usage**
   ```bash
   claude-roo run --prompt "What is the weather like today?"
   ```

3. **With System Prompt**
   ```bash
   claude-roo run \
     --system-prompt "You are a weather expert" \
     --prompt "Explain how rain forms"
   ```

## Features

### Text Input
Provide additional context or data:
```bash
claude-roo run \
  --prompt "Summarize this text" \
  --text-input "Your long text here..."
```

### File Processing
Map files into the agent's workspace:
```bash
claude-roo run \
  --prompt "Analyze the data in report.csv" \
  --files "report.csv:/path/to/report.csv:./"
```

### Folder Mapping
Map entire directories:
```bash
claude-roo run \
  --prompt "Review the code in the src folder" \
  --folders "source:/path/to/project/src:./src"
```

### GitHub Repository
Clone repositories for analysis:
```bash
claude-roo run \
  --prompt "Review this repository structure" \
  --github "https://github.com/user/repo:./repo"
```

### Interactive Mode
Start an interactive session:
```bash
claude-roo interactive --system-prompt "You are a coding assistant"
```

## Advanced Usage

### Multiple File Mappings
```bash
claude-roo run \
  --prompt "Compare these files" \
  --files "file1.txt:/path/to/file1.txt:./" \
  --files "file2.txt:/path/to/file2.txt:./"
```

### Custom Working Directory
```bash
claude-roo run \
  --working-dir "/custom/workspace" \
  --prompt "Your prompt here"
```

### Environment Variables
- `CLAUDE_MODEL`: Specify the Claude model to use
- `CLAUDE_API_KEY`: Your API key (if not using OAuth)

## Examples

See the `examples/` directory for complete examples:
- `01-basic-usage.ts`: Simple text queries
- `02-file-processing.ts`: Working with files
- `03-interactive-session.ts`: Interactive chat session

## Troubleshooting

1. **Agent fails to start**: Ensure Claude CLI is installed
2. **Permission errors**: Check file/folder permissions
3. **Timeout errors**: Increase timeout in configuration

For more help, run:
```bash
claude-roo --help
```
```

## Success Criteria
- [x] Integration tests cover all major scenarios
- [x] Examples demonstrate key features
- [x] Interactive mode works smoothly
- [x] Error handling is user-friendly
- [x] Documentation is clear and comprehensive
- [x] All tests pass in CI/CD environment

## Estimated Time
2-3 hours

## Dependencies
- Steps 1-4 must be complete
- Test environment with Claude CLI

## Output
- Complete integration test suite
- Working examples for all features
- User documentation
- Validated end-to-end functionality
# Step 4: Simple Single Agent System

## Objective
Create a complete working single-agent system that can accept inputs and execute tasks end-to-end.

## Tasks

### 4.1 Simple Agent Implementation

#### Test Suite First (TDD)
```typescript
// src/agents/specialized/__tests__/SimpleAgent.test.ts
import { SimpleAgent } from '../SimpleAgent';
import { IAgentConfig, ITask } from '../../base/types';
import { CLIProcessManager } from '../../../cli/CLIProcessManager';

describe('SimpleAgent', () => {
  let agent: SimpleAgent;
  let processManager: CLIProcessManager;

  beforeEach(async () => {
    processManager = new CLIProcessManager();
    const config: IAgentConfig = {
      id: 'simple-agent-1',
      name: 'Simple Agent',
      type: 'simple',
      workingDirectory: '/tmp/simple-agent-test',
      systemPrompt: 'You are a helpful assistant. Respond concisely.',
      model: 'claude-3-opus-20240229'
    };
    
    agent = new SimpleAgent(config, processManager);
    await agent.initialize();
  });

  afterEach(async () => {
    await agent.shutdown();
    await processManager.shutdown();
  });

  describe('basic task execution', () => {
    it('should execute a simple text task', async () => {
      const task: ITask = {
        id: 'task-1',
        type: 'text',
        description: 'What is 2 + 2?',
        parameters: {}
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result).toContain('4');
    });

    it('should handle text input parameter', async () => {
      const task: ITask = {
        id: 'task-2',
        type: 'text',
        description: 'Summarize the following text',
        parameters: {
          textInput: 'This is a long text that needs to be summarized...'
        }
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result).toBeDefined();
    });

    it('should respect system prompt', async () => {
      const task: ITask = {
        id: 'task-3',
        type: 'text',
        description: 'Tell me a joke',
        parameters: {}
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result.length).toBeLessThan(200); // Concise response
    });
  });

  describe('file operations', () => {
    it('should process files in working directory', async () => {
      const task: ITask = {
        id: 'task-4',
        type: 'file-analysis',
        description: 'List all files in the current directory',
        parameters: {}
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result).toBeDefined();
    });

    it('should handle file mappings', async () => {
      const task: ITask = {
        id: 'task-5',
        type: 'process-file',
        description: 'Read and summarize the content of readme.txt',
        parameters: {
          files: [{
            name: 'readme.txt',
            srcPath: '/tmp/test-readme.txt',
            destPath: './'
          }]
        }
      };

      // Create test file
      await fs.writeFile('/tmp/test-readme.txt', 'This is a test readme file.');

      const result = await agent.execute(task);

      expect(result.status).toBe('completed');
      expect(result.result).toContain('test readme');
    });
  });

  describe('error handling', () => {
    it('should handle invalid tasks gracefully', async () => {
      const task: ITask = {
        id: 'task-6',
        type: 'invalid',
        description: '',
        parameters: {}
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('failed');
      expect(result.error).toBeDefined();
    });

    it('should handle CLI process errors', async () => {
      // Simulate process crash
      const task: ITask = {
        id: 'task-7',
        type: 'crash-test',
        description: 'This should crash the process',
        parameters: { simulateCrash: true }
      };

      const result = await agent.execute(task);

      expect(result.status).toBe('failed');
      expect(result.error).toContain('process');
    });
  });
});
```

### 4.2 Simple Agent Implementation

```typescript
// src/agents/specialized/SimpleAgent.ts
import { BaseAgent } from '../base/BaseAgent';
import { IAgentConfig, IAgentContext, ITask } from '../base/types';
import { CLIProcessManager } from '../../cli/CLIProcessManager';
import { FileFolderMapper } from '../../cli/FileFolderMapper';
import * as path from 'path';

export class SimpleAgent extends BaseAgent {
  private processManager: CLIProcessManager;
  private cliProcess: any;
  private fileFolderMapper: FileFolderMapper;

  constructor(config: IAgentConfig, processManager: CLIProcessManager) {
    super(config);
    this.processManager = processManager;
    this.fileFolderMapper = new FileFolderMapper();
  }

  protected async onInitialize(): Promise<void> {
    // Spawn CLI process for this agent
    this.cliProcess = await this.processManager.spawnAgent(this.config);
    this.logger.info(`Simple agent ${this.id} CLI process spawned`);
  }

  protected async onShutdown(): Promise<void> {
    // Terminate CLI process
    if (this.cliProcess) {
      await this.processManager.terminateAgent(this.id);
    }
  }

  protected async performTask(task: ITask, context: IAgentContext): Promise<any> {
    try {
      // Handle file mappings if provided
      if (task.parameters?.files) {
        await this.fileFolderMapper.mapFiles(
          this.config.workingDirectory,
          task.parameters.files
        );
      }

      if (task.parameters?.folders) {
        await this.fileFolderMapper.mapFolders(
          this.config.workingDirectory,
          task.parameters.folders
        );
      }

      if (task.parameters?.github) {
        await this.fileFolderMapper.cloneGitRepos(
          this.config.workingDirectory,
          task.parameters.github
        );
      }

      // Build prompt for Claude
      const prompt = this.buildPromptForTask(task);

      // Send to CLI process
      const cliTask = {
        id: task.id,
        type: 'claude-query',
        prompt: prompt,
        context: {
          workingDirectory: this.config.workingDirectory,
          ...context
        }
      };

      const result = await this.processManager.sendTask(this.id, cliTask);

      // Parse and return result
      return this.parseCliResult(result);

    } catch (error) {
      this.logger.error(`Error performing task ${task.id}:`, error);
      throw error;
    }
  }

  private buildPromptForTask(task: ITask): string {
    let prompt = task.description;

    // Add text input if provided
    if (task.parameters?.textInput) {
      prompt += `\n\nInput text:\n${task.parameters.textInput}`;
    }

    // Add file context if needed
    if (task.type === 'file-analysis' || task.type === 'process-file') {
      prompt += '\n\nNote: You have access to files in your working directory.';
    }

    return prompt;
  }

  private parseCliResult(cliOutput: string): any {
    try {
      // Try to parse as JSON first
      return JSON.parse(cliOutput);
    } catch {
      // Return as plain text if not JSON
      return cliOutput;
    }
  }
}
```

### 4.3 Main Entry Point

```typescript
// src/index.ts
import { Command } from 'commander';
import { SimpleAgent } from './agents/specialized/SimpleAgent';
import { CLIProcessManager } from './cli/CLIProcessManager';
import { IAgentConfig, ITask } from './agents/base/types';
import * as fs from 'fs/promises';
import * as path from 'path';

const program = new Command();

program
  .name('claude-roo')
  .description('Claude Multi-Agent System')
  .version('0.1.0');

program
  .command('run')
  .description('Run a single agent with the given task')
  .option('-s, --system-prompt <prompt>', 'System prompt for the agent')
  .option('-p, --prompt <prompt>', 'Task prompt')
  .option('-t, --text-input <text>', 'Text input for the task')
  .option('-f, --files <files...>', 'Files to map (format: name:src:dest)')
  .option('-d, --folders <folders...>', 'Folders to map (format: name:src:dest)')
  .option('-g, --github <repos...>', 'GitHub repos to clone (format: url:dest)')
  .option('-w, --working-dir <dir>', 'Working directory', '/tmp/claude-agent')
  .action(async (options) => {
    const processManager = new CLIProcessManager();

    try {
      // Create agent configuration
      const config: IAgentConfig = {
        id: `agent-${Date.now()}`,
        name: 'CLI Agent',
        type: 'simple',
        workingDirectory: options.workingDir,
        systemPrompt: options.systemPrompt || 'You are a helpful AI assistant.',
        model: process.env.CLAUDE_MODEL || 'claude-3-opus-20240229'
      };

      // Parse file mappings
      const files = options.files?.map(f => {
        const [name, src, dest] = f.split(':');
        return { name, srcPath: src, destPath: dest || './' };
      });

      // Parse folder mappings
      const folders = options.folders?.map(f => {
        const [name, src, dest] = f.split(':');
        return { name, srcPath: src, destPath: dest || './' };
      });

      // Parse GitHub mappings
      const github = options.github?.map(g => {
        const [url, dest] = g.split(':');
        return { github: url, destPath: dest || './' };
      });

      // Create task
      const task: ITask = {
        id: `task-${Date.now()}`,
        type: 'text',
        description: options.prompt || 'Hello, how can you help me?',
        parameters: {
          textInput: options.textInput,
          files,
          folders,
          github
        }
      };

      // Create and run agent
      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      console.log('Agent initialized. Executing task...');
      const result = await agent.execute(task);

      if (result.status === 'completed') {
        console.log('\nResult:');
        console.log(typeof result.result === 'string' 
          ? result.result 
          : JSON.stringify(result.result, null, 2));
      } else {
        console.error('\nTask failed:', result.error);
        process.exit(1);
      }

      await agent.shutdown();
      await processManager.shutdown();

    } catch (error) {
      console.error('Error:', error.message);
      await processManager.shutdown();
      process.exit(1);
    }
  });

program
  .command('interactive')
  .description('Run an interactive agent session')
  .option('-s, --system-prompt <prompt>', 'System prompt for the agent')
  .option('-w, --working-dir <dir>', 'Working directory', '/tmp/claude-agent')
  .action(async (options) => {
    const processManager = new CLIProcessManager();
    const readline = require('readline').createInterface({
      input: process.stdin,
      output: process.stdout
    });

    try {
      const config: IAgentConfig = {
        id: `agent-interactive-${Date.now()}`,
        name: 'Interactive Agent',
        type: 'simple',
        workingDirectory: options.workingDir,
        systemPrompt: options.systemPrompt || 'You are a helpful AI assistant.',
        model: process.env.CLAUDE_MODEL || 'claude-3-opus-20240229'
      };

      const agent = new SimpleAgent(config, processManager);
      await agent.initialize();

      console.log('Interactive agent ready. Type "exit" to quit.\n');

      const askQuestion = () => {
        readline.question('You: ', async (input) => {
          if (input.toLowerCase() === 'exit') {
            await agent.shutdown();
            await processManager.shutdown();
            readline.close();
            return;
          }

          const task: ITask = {
            id: `task-${Date.now()}`,
            type: 'text',
            description: input,
            parameters: {}
          };

          const result = await agent.execute(task);
          
          if (result.status === 'completed') {
            console.log('\nAgent:', result.result);
          } else {
            console.error('\nError:', result.error);
          }
          
          console.log(''); // Empty line for readability
          askQuestion();
        });
      };

      askQuestion();

    } catch (error) {
      console.error('Error:', error.message);
      await processManager.shutdown();
      readline.close();
      process.exit(1);
    }
  });

program.parse(process.argv);
```

### 4.4 Example Usage Script

```bash
#!/bin/bash
# examples/simple-agent-demo.sh

echo "=== Claude Agent System Demo ==="
echo

# Example 1: Simple text prompt
echo "1. Simple text prompt:"
node dist/index.js run \
  --prompt "What is the capital of France?" \
  --system-prompt "You are a geography expert. Answer concisely."

echo -e "\n---\n"

# Example 2: With text input
echo "2. With text input:"
echo "The quick brown fox jumps over the lazy dog." > /tmp/sample.txt
node dist/index.js run \
  --prompt "Count the words in the provided text" \
  --text-input "$(cat /tmp/sample.txt)"

echo -e "\n---\n"

# Example 3: With file mapping
echo "3. With file mapping:"
echo "This is a test file for the agent to process." > /tmp/test-file.txt
node dist/index.js run \
  --prompt "Read test.txt and tell me what it contains" \
  --files "test.txt:/tmp/test-file.txt:./"

echo -e "\n---\n"

# Example 4: Interactive mode
echo "4. Interactive mode (type 'exit' to quit):"
node dist/index.js interactive \
  --system-prompt "You are a helpful coding assistant."
```

## Success Criteria
- [x] Single agent can be spawned and execute tasks
- [x] System accepts all specified inputs (prompt, text, files, folders, GitHub)
- [x] Agent responds appropriately to tasks
- [x] File/folder mappings work correctly
- [x] Interactive mode functions properly
- [x] Error handling is robust
- [x] Examples run successfully
- [x] 100% test coverage maintained

## Estimated Time
3-4 hours

## Dependencies
- Steps 1-3 must be complete
- Claude CLI must be installed and configured

## Output
- Working single-agent system
- Command-line interface
- Interactive mode
- Complete examples demonstrating all features
- End-to-end functionality verified